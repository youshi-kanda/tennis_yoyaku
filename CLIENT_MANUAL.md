# テニスコート自動予約システム - 利用マニュアル

**バージョン**: 1.0  
**最終更新日**: 2025年11月30日

---

## 📱 システム概要

このシステムは、品川区・港区のテニスコート予約を24時間自動で監視し、空きが出たら自動で予約するPWA（プログレッシブウェブアプリ）です。

### 主な機能
- ✅ 品川区・港区の複数施設を同時監視
- ✅ 空き枠を自動検知・自動予約
- ✅ プッシュ通知でリアルタイム通知
- ✅ スマホのホーム画面に追加可能
- ✅ オフラインでも一部機能が利用可能

---

## 🌐 アクセス方法

### アプリURL
```
https://pwa-rho-gray.vercel.app/
```

### 推奨環境
- **iOS**: Safari 15.0以降
- **Android**: Chrome 90以降
- **PC**: Chrome, Edge, Safari（最新版）

---

## 📲 初期設定（初回のみ）

### 1. ホーム画面に追加（推奨）

#### iOS（iPhone/iPad）の場合
1. Safariでアプリを開く
2. 画面下の「共有」ボタンをタップ
3. 「ホーム画面に追加」を選択
4. 「追加」をタップ

#### Androidの場合
1. Chromeでアプリを開く
2. 画面右上の「︙」メニューをタップ
3. 「ホーム画面に追加」を選択
4. 「追加」をタップ

### 2. ログイン

**初回ログイン時のパスワード変更（重要）**

管理者から受け取ったメールアドレスとパスワードでログイン後、セキュリティのため**必ず**パスワードを変更してください。

1. ログイン後、画面下部の「設定」アイコンをタップ
2. 「パスワード変更」セクションで以下を入力:
   - 現在のパスワード（管理者から受け取ったもの）
   - 新しいパスワード（8文字以上）
   - 新しいパスワード（確認用）
3. 「パスワードを変更」ボタンをタップ
4. 変更後、自動的にログアウトされます
5. 新しいパスワードで再度ログインしてください

### 3. 初回設定の確認

管理者から受け取ったログイン情報を入力します。

```
メールアドレス: （管理者から受領）
パスワード: （管理者から受領）
```

⚠️ **初回ログイン後、必ずパスワードを変更してください**

### 3. パスワード変更

1. ログイン後、右上の「ログアウト」の隣にあるメニューから「設定」を開く
2. 「パスワード変更」セクションで新しいパスワードを設定
3. 「保存」をタップ

### 4. プッシュ通知を有効化

1. 「設定」タブを開く
2. 「プッシュ通知」セクションで「プッシュ通知を有効化」をタップ
3. ブラウザの通知許可を「許可」

---

## 🎾 予約サイトの登録

監視を開始する前に、各区の予約サイトのログイン情報を登録する必要があります。

### 品川区の場合

1. **設定タブ** を開く
2. 「品川区スポーツ予約」セクションで以下を入力：
   - **利用者ID**: （品川区のID）
   - **パスワード**: （品川区のパスワード）
3. 「保存」をタップ

**品川区予約サイト**: https://www.cm9.eprs.jp/shinagawa/web/

### 港区の場合

1. **設定タブ** を開く
2. 「港区スポーツ予約」セクションで以下を入力：
   - **利用者ID**: （港区のID）
   - **パスワード**: （港区のパスワード）
3. 「保存」をタップ

**港区予約サイト**: https://web101.rsv.ws-scs.jp/web/

⚠️ **重要**: ID・パスワードは暗号化されて安全に保存されます。

---

## 🔍 監視設定の追加

### 基本的な流れ

1. **監視設定タブ** を開く
2. 「監視設定を開始する」ボタンをタップ
3. 3つのステップで設定を完了

### ステップ1: 施設選択

1. **地区を選択**: 品川区 or 港区
2. **施設を選択**: プルダウンから希望の施設を選択
   - 例: 天王洲公園庭球場、芝浦中央公園庭球場など

### ステップ2: 日時設定

#### 監視する日付を選択

3つのモードから選択できます：

**A. 単一日付モード**
- カレンダーから1日だけ選択
- 特定の日だけ予約したい場合に使用

**B. 期間指定モード**
- 開始日と終了日を選択
- 複数日をまとめて監視したい場合に使用

**C. 継続監視モード** （おすすめ）
- 予約可能な全期間を自動で監視
- 品川区: 翌月末まで（最大60日）
- 港区: 翌々月5日まで（最大65日）

#### 監視する曜日を選択

- 月〜日の中から希望の曜日にチェック
- 複数選択可能
- 例: 「土曜日と日曜日だけ」など

#### 祝日の扱い

- **祝日を含める**: 平日・祝日すべてを監視
- **祝日を除外**: 平日のみ監視
- **祝日のみ**: 祝日だけ監視

#### 監視する時間帯を選択

- 午前・午後の時間枠から複数選択可能
- 例: 「9:00-11:00」「11:00-13:00」など
- 複数選択すると、どれか1つでも空けば予約されます

### ステップ3: 詳細設定

#### 自動予約

- **ON（推奨）**: 空きを見つけたら自動で予約
- **OFF**: 空き通知のみ（自動予約しない）

#### 完了

「監視を開始」ボタンをタップして設定完了！

---

## 📊 ダッシュボードの見方

### 監視中の施設

カードに表示される情報：
- **施設名**: 監視中のテニスコート
- **日付**: 監視対象の日付
- **時間帯**: 監視中の時間枠
- **ステータス**: 
  - 🟢 **稼働中**: 現在監視中
  - ⏸️ **一時停止**: 監視を停止中
  - ✅ **完了**: 予約成功

### 統計情報

- **監視中の施設**: アクティブな監視設定の数
- **予約履歴**: 総予約試行回数
- **予約成功率**: 予約の成功確率

---

## 🔔 プッシュ通知について

### 通知が届くタイミング

1. **🎉 予約成功**: 自動予約が成功した時
2. **🔥「取」検知**: キャンセル待ち枠を検知した時（集中監視開始の通知）
   - 通知内容: 施設名、日時、次回監視時刻（10分単位）
3. **❌ エラー発生**: ログイン失敗などのエラー時

### 通知が届かない場合

1. プッシュ通知が有効になっているか確認
2. スマホの「設定」→「通知」で許可されているか確認
3. 機内モードやおやすみモードを確認

---

## ⚙️ 監視の一時停止・再開・削除

### 一時停止

1. ダッシュボードで監視設定のカードをタップ
2. 「⏸️ 停止」ボタンをタップ
3. 確認ダイアログで「OK」

→ 設定は保持されたまま、監視だけが停止します

### 再開

1. 停止中の監視設定のカードをタップ
2. 「▶️ 再開」ボタンをタップ

### 削除

1. ダッシュボードで監視設定のカードをタップ
2. 「🗑️ 削除」ボタンをタップ
3. 確認ダイアログで「OK」

⚠️ **削除すると設定は完全に消去されます**

---

## 📅 予約履歴の確認

### 予約履歴タブ

1. 「予約履歴」タブを開く
2. 過去の予約試行がリスト表示されます

### 表示される情報

- **日時**: 予約を試行した日時
- **施設名**: 予約したコート
- **ステータス**:
  - ✅ **成功**: 予約完了
  - ❌ **失敗**: 予約できなかった
- **メッセージ**: 詳細な結果

---

## ⚙️ 設定ページの機能

### アカウント情報

- **メールアドレス**: 現在ログイン中のアカウント
- **ロール**: 一般ユーザー or 管理者

### パスワード変更（重要）

初回ログイン後、必ずパスワードを変更してください:

1. 「設定」タブを開く
2. 「パスワード変更」セクションで入力:
   - 現在のパスワード
   - 新しいパスワード（8文字以上）
   - 新しいパスワード（確認用）
3. 「パスワードを変更」ボタンをタップ
4. 成功すると自動的にログアウトされます
5. 新しいパスワードで再度ログインしてください

⚠️ **注意事項**:
- パスワードは8文字以上で設定してください
- 現在のパスワードと異なるものを設定してください
- 定期的にパスワードを変更することを推奨します

### 施設サイトの認証情報設定

品川区・港区のサイトにログインするための情報を登録します。

#### 品川区

**セッション方式（推奨）**:
1. 品川区予約サイトのリンクをタップ
2. 別タブでログイン
3. 「セッション取得」ボタンをタップ

**ID/パスワード方式**（後方互換性のみ）:
- 将来のreCAPTCHA導入時に動作しなくなる可能性があります

#### 港区

**セッション方式のみ対応**:
1. 港区予約サイトのリンクをタップ
2. 別タブでログイン（reCAPTCHAチェックを含む）
3. 「セッション取得」ボタンをタップ

⚠️ 港区サイトはreCAPTCHA実装のため、ID/パスワード方式は利用できません

### 予約上限設定

予約しすぎを防ぐための上限設定:

- **週あたりの予約上限**: 例）週2回まで
- **月あたりの予約上限**: 例）月8回まで
- 0に設定すると制限なし
- 上限に達すると監視は継続するが自動予約は停止

### プッシュ通知設定

- **有効にする**: 予約成功・失敗時に通知を受け取る
- **無効にする**: 通知を停止

---

## 🕐 システムの動作タイミング

### 監視の頻度

#### 通常監視
- **実行間隔**: 1分ごとにチェック
- **対象**: すべてのアクティブな監視設定

#### 集中監視（品川区「取」マーク対応）
品川区で「取」（キャンセル待ち）マークを検知した場合、自動的に集中監視モードに移行します。

**動作の流れ:**
1. **「取」検知**: 通常監視で「取」マークを発見
2. **次の10分単位を計算**: 例）17:34検知 → 17:40が次の監視時刻
3. **10分間隔で監視**: 17:40, 17:50, 18:00... と10分ごとに監視
4. **前後15秒間を集中チェック**: 各監視時刻の前後15秒（合計30秒間）を1秒間隔でチェック
   - 例: 17:40の監視 → 17:39:45～17:40:15の30秒間
5. **自動終了条件**:
   - ✅ 「○」検知 → 自動予約実行 → 通常監視に復帰
   - ❌ 「×」検知 → 取マーク消失 → 通常監視に復帰
   - ⏰ 予約開始時刻到達 → 通常監視に復帰

**特徴:**
- リソース効率的: 30秒×30回/10分（従来比95%削減）
- ピンポイント監視: 「○」に変わりやすい10分単位に集中
- 並列処理: 他の監視設定を妨げない

### 自動予約のタイミング

- **5:00一斉予約**: 毎日5:00に翌日分の予約を一斉実行
- **随時予約**: キャンセル枠が出たら即座に予約
- **集中監視**: 「取」→「○」変化時に即座に予約

### 深夜のメンテナンス

- **3:15**: セッション自動リセット
- **24:00〜3:15**: 品川区サイトがメンテナンス中のため監視停止

---

## ❓ よくある質問（FAQ）

### Q1. 複数の施設を同時に監視できますか？
**A.** はい、できます。監視設定を複数追加することで、何件でも同時に監視できます。

### Q2. 予約が取れたら自動で監視は停止しますか？
**A.** はい、単一日付モードでは予約成功後に自動で「完了」状態になります。継続監視モードでは他の日付の監視が継続されます。

### Q3. アカウントのパスワードを変更したい
**A.** 設定タブの「パスワード変更」セクションから変更できます。現在のパスワード、新しいパスワード（8文字以上）を入力して変更してください。変更後は自動的にログアウトされるので、新しいパスワードで再ログインしてください。

### Q3-2. 予約サイト（品川区・港区）のパスワードを変更したら？
**A.** 設定タブで新しいパスワードを再登録してください。セッション方式の場合は、新しいパスワードでログインした後に再度「セッション取得」を実行してください。

### Q4. スマホを機種変更したらどうなりますか？
**A.** 新しいスマホで同じメールアドレス・パスワードでログインすれば、監視設定はそのまま引き継がれます。プッシュ通知は再度有効化が必要です。

### Q5. 予約の上限はありますか？
**A.** 各予約サイトのルールに従います（品川区・港区それぞれの予約上限に準拠）。

### Q6. 料金はかかりますか？
**A.** このシステムの利用料は無料です。ただし、各区の予約サイトでの施設利用料は別途必要です。

### Q7. 複数人で同じアカウントを使えますか？
**A.** できません。このシステムは1アカウント1ユーザーを前提に設計されています。複数人で同じアカウントを共有すると、監視設定の競合や予約上限の超過により、システムが正常に動作しなくなる可能性があります。必ず各自で個別のアカウントを作成してご利用ください。

### Q8. 監視を止めるにはどうすればいいですか？
**A.** 監視設定を「一時停止」または「削除」してください。アプリを閉じるだけでは監視は継続されます。

### Q9. 予約に失敗した場合は？
**A.** 予約履歴で原因を確認できます。ログイン情報のエラーや満室が主な理由です。

### Q10. オフラインでも使えますか？
**A.** 一部機能（ダッシュボード表示など）はオフラインでも動作しますが、監視・予約はインターネット接続が必要です。

---

## 🚨 トラブルシューティング

### ログインできない

**原因**:
- メールアドレスまたはパスワードが間違っている
- アカウントが削除されている

**対処法**:
- 入力内容を確認
- 管理者に連絡してアカウント状態を確認

### 監視が動作しない

**原因**:
- 予約サイトのログイン情報が未設定または間違っている
- 監視が一時停止中
- 深夜時間帯（24:00〜3:15）

**対処法**:
1. 設定タブで各区のID・パスワードを確認
2. ダッシュボードで監視ステータスを確認
3. 時間帯を確認（深夜は自動的に停止）

### プッシュ通知が届かない

**原因**:
- プッシュ通知が有効になっていない
- スマホの通知設定で許可されていない
- 機内モード・おやすみモード

**対処法**:
1. 設定タブでプッシュ通知を有効化
2. スマホの設定で通知を許可
3. 保守点検機能でテスト通知を送信して確認

### 予約が失敗する

**原因**:
- セッション期限切れ
- 予約サイトのパスワード変更
- 満室（他の人が先に予約）

**対処法**:
1. 予約サイトで直接ログインできるか確認
2. 設定タブでID・パスワードを再登録
3. 予約履歴でエラーメッセージを確認

---

## 📞 サポート・お問い合わせ

### システム管理者への連絡

**問い合わせ前に確認すること**:
1. 予約履歴のエラーメッセージ
2. 設定タブの登録内容
3. 問題が発生した日時

**連絡先**: システム管理者から別途案内

---

## 🔒 セキュリティとプライバシー

### データの保護

- すべての通信は暗号化（HTTPS）
- パスワードは暗号化して保存
- 個人情報は厳重に管理

### データの保存場所

- **Cloudflare Workers**: サーバーサイド処理
- **Cloudflare KV**: ユーザーデータ・監視設定
- **Vercel**: PWAアプリケーション

### データの削除

アカウント削除を希望する場合は、管理者に連絡してください。

---

## 📝 更新履歴

### v1.1 (2025年11月30日) - 集中監視最適化
**新機能・改善:**
- 🔥 **品川区「取」マーク集中監視の最適化**
  - 検知後、次の10分単位（10, 20, 30, 40, 50, 00分）から監視開始
  - 各10分単位の前後15秒間（30秒）を1秒間隔でチェック
  - 10分ごとに継続監視（従来の15分間連続監視から変更）
  - リソース使用量95%削減（450回 → 30回/10分）
- ✅ **明確な終了条件の実装**
  - 「○」検知 → 自動予約 → 通常監視復帰
  - 「×」検知 → 取マーク消失 → 通常監視復帰
  - 予約開始時刻到達 → 通常監視復帰
- 🚀 **並列処理の維持**
  - 集中監視中も他の監視設定は独立して動作
  - 複数ターゲットの同時監視をサポート
- 🎨 **PWA UI改善**
  - 設定画面を折りたたみ式カードに変更
  - カレンダーに4色ステータス表示（監視中🔵、空き検知🟡、予約成功🟢、予約失敗🔴）
  - 各ステータスの詳細情報を右側パネルに表示

**技術的改善:**
- Cloudflare Workers CPU時間の最適化
- KVアクセスの効率化
- エラーハンドリングの強化

### v1.0 (2025年11月28日)
- 初回リリース
- 品川区・港区対応
- プッシュ通知機能
- 自動予約機能
- 継続監視モード

---

**このマニュアルについて**:  
このマニュアルは、システムの実際の動作に基づいて作成されています。不明点や追加で知りたいことがあれば、管理者にお問い合わせください。

**最終更新**: 2025年11月30日 v1.1
