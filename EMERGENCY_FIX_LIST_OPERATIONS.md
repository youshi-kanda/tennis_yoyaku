# ğŸš¨ ç·Šæ€¥ä¿®æ­£: KV list()æ“ä½œã®æ’é™¤

## å•é¡Œ

Phase 1å®Ÿè£…å¾Œã‚‚KVåˆ¶é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿï¼š
```
"error": "Unauthorized: KV list() limit exceeded for the day."
```

## æ ¹æœ¬åŸå› 

**list()æ“ä½œã‚‚readåˆ¶é™ã«ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ï¼**

ç¾çŠ¶ã®å•é¡Œç®‡æ‰€ï¼š
1. `getAllActiveTargets()` - æ¯Cronã§list()å®Ÿè¡Œ
2. `handleMonitoringList()` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒUIé–‹ããŸã³ã«list()å®Ÿè¡Œ
3. `getUserReservations()` - æ¯ãƒã‚§ãƒƒã‚¯ã§list()å®Ÿè¡Œ

### ä½¿ç”¨é‡è¨ˆç®—ï¼ˆä¿®æ­£å‰ï¼‰

3æ–½è¨­ã®å ´åˆã€1å›ã®Cronå®Ÿè¡Œã§ï¼š
- `getAllActiveTargets()`: 1 list() + 3 get() = 4 reads
- `getUserReservations()` Ã— 3å›: 3 list() + Î± get() = 3+ reads
- **åˆè¨ˆ**: 7+ reads per Cron

1æ—¥ï¼ˆ288å›Cronï¼‰: 7 Ã— 288 = **2,016 reads/æ—¥**

ã•ã‚‰ã«UIã‚¢ã‚¯ã‚»ã‚¹ã§`handleMonitoringList()`ãŒå‘¼ã°ã‚Œã‚‹ã¨è¿½åŠ ã§list()ãŒç™ºç”Ÿã€‚

---

## è§£æ±ºç­–: list()å®Œå…¨æ’é™¤

### æˆ¦ç•¥
KVã®`list()`ã‚’ä¸€åˆ‡ä½¿ã‚ãšã€å…¨ã¦ã®ãƒªã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’1ã¤ã®ã‚­ãƒ¼ã«é…åˆ—ã¨ã—ã¦ä¿å­˜ã€‚

### å®Ÿè£…å†…å®¹

#### 1. ç›£è¦–ãƒªã‚¹ãƒˆç®¡ç†ã®å¤‰æ›´

**Before:**
```typescript
// å„ç›£è¦–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å€‹åˆ¥ã«ä¿å­˜
await kv.put(`target:${userId}:${targetId}`, JSON.stringify(target));

// å–å¾—æ™‚ã«list()ã‚’ä½¿ç”¨
const list = await kv.list({ prefix: 'target:' });
```

**After:**
```typescript
// å…¨ç›£è¦–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’1ã¤ã®é…åˆ—ã§ä¿å­˜
await kv.put('monitoring:all_targets', JSON.stringify(allTargets));

// å–å¾—æ™‚ã¯get()ã®ã¿
const allTargets = await kv.get('monitoring:all_targets', 'json') || [];
```

#### 2. äºˆç´„å±¥æ­´ç®¡ç†ã®å¤‰æ›´

**Before:**
```typescript
// å„äºˆç´„ã‚’å€‹åˆ¥ã«ä¿å­˜
await kv.put(`history:${userId}:${reservationId}`, JSON.stringify(history));

// å–å¾—æ™‚ã«list()ã‚’ä½¿ç”¨
const list = await kv.list({ prefix: `history:${userId}:` });
```

**After:**
```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«äºˆç´„é…åˆ—ã‚’ä¿å­˜
await kv.put(`history:${userId}`, JSON.stringify(userHistories));

// å–å¾—æ™‚ã¯get()ã®ã¿
const userHistories = await kv.get(`history:${userId}`, 'json') || [];
```

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1.5: list()æ’é™¤ï¼ˆç·Šæ€¥ï¼‰

#### ç›£è¦–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç®¡ç†
- [ ] `monitoring:all_targets`ã‚­ãƒ¼æ§‹é€ ã®å®Ÿè£…
- [ ] `addMonitoringTarget()`é–¢æ•°ã®ä½œæˆ
- [ ] `removeMonitoringTarget()`é–¢æ•°ã®ä½œæˆ
- [ ] `getAllActiveTargets()`ã‚’list()ä¸è¦ã«ä¿®æ­£
- [ ] `handleMonitoringList()`ã‚’list()ä¸è¦ã«ä¿®æ­£
- [ ] `handleMonitoringCreate()`ã§é…åˆ—ã‚’æ›´æ–°

#### äºˆç´„å±¥æ­´ç®¡ç†
- [ ] `history:{userId}`ã‚­ãƒ¼æ§‹é€ ã®å®Ÿè£…
- [ ] `addReservationHistory()`é–¢æ•°ã®ä½œæˆ
- [ ] `getUserReservations()`ã‚’list()ä¸è¦ã«ä¿®æ­£
- [ ] æ—¢å­˜ã®äºˆç´„å±¥æ­´ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

#### ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§list()ãŒå‘¼ã°ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§readæ•°ãŒæ¿€æ¸›ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤

---

## æœŸå¾…åŠ¹æœ

### KVä½¿ç”¨é‡ï¼ˆ3æ–½è¨­ã€ä¿®æ­£å¾Œï¼‰

**1å›ã®Cronå®Ÿè¡Œ:**
- ç›£è¦–ãƒªã‚¹ãƒˆå–å¾—: 1 getï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§0.1å›ï¼‰ = 0.1 reads
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾— Ã— 3: 3 getï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§0.3å›ï¼‰ = 0.3 reads
- äºˆç´„å±¥æ­´ Ã— 3: 3 getï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ç„¡ã„ãŒ1å›ãšã¤ï¼‰ = 3 reads
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°: å¤‰æ›´æ™‚ã®ã¿write = 0.3 writes

**åˆè¨ˆ: 3.4 reads + 0.3 writes per Cron**

**1æ—¥ï¼ˆ288å›ï¼‰:**
- **Reads**: 3.4 Ã— 288 = **979 reads/æ—¥** âœ…
- **Writes**: 0.3 Ã— 288 = **86 writes/æ—¥** âœ…

### 24æ–½è¨­ã‚¹ã‚±ãƒ¼ãƒ«æ™‚
- **Reads**: 979 reads/æ—¥ï¼ˆåˆ¶é™ã®1%ï¼‰
- **Writes**: 86 writes/æ—¥ï¼ˆåˆ¶é™ã®8.6%ï¼‰

**æ®‹ä½™ãƒãƒ¼ã‚¸ãƒ³: 91%ä»¥ä¸Šï¼**

---

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ è¨­è¨ˆ

### monitoring:all_targets
```json
[
  {
    "id": "uuid-1",
    "userId": "user-123",
    "site": "shinagawa",
    "facilityId": "facility-1",
    "facilityName": "ã—ãªãŒã‚ä¸­å¤®å…¬åœ’ã‚³ãƒ¼ãƒˆA",
    "date": "2025-02-01",
    "timeSlot": "09:00-11:00",
    "status": "active",
    "autoReserve": true,
    "lastStatus": "Ã—",
    "lastCheck": 1643673600000,
    "createdAt": 1643673600000
  },
  {
    "id": "uuid-2",
    "userId": "user-123",
    "site": "minato",
    ...
  }
]
```

### history:{userId}
```json
[
  {
    "id": "uuid-1",
    "userId": "user-123",
    "site": "shinagawa",
    "facilityId": "facility-1",
    "facilityName": "ã—ãªãŒã‚ä¸­å¤®å…¬åœ’ã‚³ãƒ¼ãƒˆA",
    "date": "2025-02-01",
    "timeSlot": "09:00-11:00",
    "status": "success",
    "reservedAt": 1643673600000
  },
  {
    "id": "uuid-2",
    "userId": "user-123",
    ...
  }
]
```

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ç§»è¡Œæ‰‹é †ï¼š

1. **èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤**
   - æ—¢å­˜ã®list()ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ™‚çš„ã«æ®‹ã™
   - æ–°æ§‹é€ ã¸ã®æ›¸ãè¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 

2. **ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
   - æ—¢å­˜ã®å€‹åˆ¥ã‚­ãƒ¼ã‚’å…¨ã¦list()ã§å–å¾—
   - æ–°ã—ã„é…åˆ—å½¢å¼ã§ä¿å­˜
   - å¤ã„ã‚­ãƒ¼ã¯å‰Šé™¤ï¼ˆã¾ãŸã¯TTLè¨­å®šï¼‰

3. **å®Œå…¨ç§»è¡Œ**
   - list()ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨å‰Šé™¤
   - æ–°æ§‹é€ ã®ã¿ä½¿ç”¨

**æ³¨**: ç¾çŠ¶ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ï¼ˆãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ1ã¤ï¼‰ãŸã‚ã€å˜ç´”ã«æ–°è¦ä½œæˆã§å•é¡Œãªã—ã€‚

---

## å„ªå…ˆåº¦

**æœ€å„ªå…ˆï¼ˆP0ï¼‰**

list()æ’é™¤ãªã—ã§ã¯24æ–½è¨­ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ä¸å¯èƒ½ã€‚
KVåˆ¶é™ãƒªã‚»ãƒƒãƒˆå¾Œã€å³åº§ã«å®Ÿè£…ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã€‚

---

## ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

### æ˜æ—¥ 2025-02-01 09:00ï¼ˆKVåˆ¶é™ãƒªã‚»ãƒƒãƒˆæ™‚ï¼‰

1. **09:00-10:00**: Phase 1.5å®Ÿè£…
   - ç›£è¦–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé…åˆ—ç®¡ç†
   - äºˆç´„å±¥æ­´é…åˆ—ç®¡ç†
   - list()å®Œå…¨å‰Šé™¤

2. **10:00-11:00**: ãƒ†ã‚¹ãƒˆï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
   - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ
   - ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
   - ãƒ‡ãƒ—ãƒ­ã‚¤

3. **11:00ä»¥é™**: Phase 2ï¼ˆ24æ™‚é–“ç›£è¦–ï¼‰
   - å®Ÿéš›ã®KVä½¿ç”¨é‡æ¸¬å®š
   - ç›®æ¨™: reads < 1,000, writes < 100

4. **ç¿Œæ—¥ä»¥é™**: Phase 3ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ï¼‰
   - 24æ–½è¨­è¿½åŠ 
   - æœ€çµ‚æ¤œè¨¼
