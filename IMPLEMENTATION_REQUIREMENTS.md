# å®Ÿè£…è¦ä»¶æ•´ç† - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦ä»¶ã¨ã®æ•´åˆæ€§

**ä½œæˆæ—¥**: 2025å¹´11æœˆ29æ—¥  
**ç›®çš„**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦ä»¶ã«åŸºã¥ã„ãŸå®Ÿè£…çŠ¶æ³ã®ç¢ºèªã¨å¯¾å¿œæ–¹é‡

---

## ğŸ“‹ è¦ä»¶æ•´ç†

### âœ… ç¢ºèªæ¸ˆã¿: ç›£è¦–é–“éš”

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦ä»¶**: æ•°ç§’ã€œæ•°åç§’å˜ä½  
**ç¾åœ¨ã®å®Ÿè£…**: 1åˆ†é–“éš”ï¼ˆCron: `*/1 * * * *`ï¼‰  
**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆ¤æ–­**: **1åˆ†é–“éš”ã§OK**

**çŠ¶æ…‹**: âœ… è¦ä»¶æº€ãŸã™ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ‰¿èªæ¸ˆã¿ï¼‰

---

## âš ï¸ å¯¾å¿œå¿…è¦: é›†ä¸­ç›£è¦–æ©Ÿèƒ½ï¼ˆå“å·åŒºã€Œå–â†’â—‹ã€ï¼‰

### è¦ä»¶è©³ç´°

**ç›®çš„**: å“å·åŒºã®ã€Œå–ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œâ—‹ã€ã«å¤‰ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ç§’å˜ä½ã§ç›£è¦–  
**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦ä»¶**: ã€Œâ—‹ã«å¤‰ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å–å¾—ãŒå¿…è¦ã€ï¼ˆæ•°ç§’ã€œæ•°åç§’ï¼‰  
**ç¾åœ¨ã®å®Ÿè£…**: æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã‚ã‚Šã€**ä½†ã—å®Ÿè¡Œé »åº¦ãŒ1åˆ†é–“éš”**

### ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³ï¼ˆworkers/src/index.tsï¼‰

```typescript
// âœ… å®Ÿè£…æ¸ˆã¿: ã€Œå–ã€æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯
if (result.currentStatus === 'å–' && target.detectedStatus !== 'å–') {
  console.log(`[Alert] ğŸ”¥ã€Œå–ã€æ¤œçŸ¥: ${date} ${timeSlot} - é›†ä¸­ç›£è¦–ãƒ¢ãƒ¼ãƒ‰é–‹å§‹`);
  
  // æ¬¡ã®10åˆ†åˆ»ã¿æ™‚åˆ»ã‚’è¨ˆç®—
  const nextTenMinuteMark = Math.ceil((currentMinutes + 1) / 10) * 10;
  const targetTime = new Date(jstNow);
  targetTime.setMinutes(nextTenMinuteMark, 0, 0);
  
  // é›†ä¸­ç›£è¦–çµ‚äº†æ™‚åˆ»: ç›®æ¨™æ™‚åˆ»ã®+2åˆ†å¾Œã¾ã§
  const intensiveUntil = new Date(targetTime.getTime() + 2 * 60 * 1000);
  
  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ›´æ–°ï¼ˆé›†ä¸­ç›£è¦–ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®šï¼‰
  target.detectedStatus = 'å–';
  target.intensiveMonitoringUntil = intensiveUntil.getTime();
  
  // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥é€ä¿¡
  await sendPushNotification(/* ... */);
}

// âœ… å®Ÿè£…æ¸ˆã¿: ã€Œå–â†’â—‹ã€å¤‰åŒ–æ¤œçŸ¥
if (result.currentStatus === 'â—‹' && target.detectedStatus === 'å–') {
  console.log(`[Alert] ğŸ‰ã€Œå–ã€â†’ã€Œâ—‹ã€å¤‰åŒ–æ¤œçŸ¥ï¼é›†ä¸­ç›£è¦–æˆåŠŸ`);
  target.detectedStatus = 'â—‹';
  target.intensiveMonitoringUntil = undefined;
}
```

### å•é¡Œç‚¹

âŒ **Cronå®Ÿè¡ŒãŒ1åˆ†é–“éš”ã®ãŸã‚ã€ç§’å˜ä½ç›£è¦–ãŒã§ããªã„**

**ã‚·ãƒŠãƒªã‚ª**:
1. 10:08ã«ã€Œå–ã€æ¤œçŸ¥ â†’ é›†ä¸­ç›£è¦–ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
2. ç›®æ¨™æ™‚åˆ»: 10:10ï¼ˆ10åˆ†åˆ»ã¿ï¼‰
3. ã—ã‹ã—æ¬¡ã®Cronå®Ÿè¡Œã¯10:09 â†’ 1å›ã—ã‹ãƒã‚§ãƒƒã‚¯ã§ããªã„
4. 10:10:03ã«ã€Œâ—‹ã€ã«å¤‰ã‚ã£ãŸå ´åˆã€10:10ã®Cronå®Ÿè¡Œã§æ¤œçŸ¥
5. **ç§’å˜ä½ã®äº‰å¥ªæˆ¦ã«é–“ã«åˆã‚ãªã„å¯èƒ½æ€§**

### è§£æ±ºç­–ã®é¸æŠè‚¢

#### æ¡ˆ1: Cloudflare Durable Objectsï¼ˆç§’å˜ä½ç›£è¦–ï¼‰

**å®Ÿè£…æ–¹æ³•**:
```typescript
// workers/src/intensive-monitor.ts
export class IntensiveMonitor {
  async fetch(request: Request) {
    const { targetId, facilityId, date, timeSlot, sessionId } = await request.json();
    
    // ç§’å˜ä½ãƒ«ãƒ¼ãƒ—é–‹å§‹ï¼ˆ60ç§’é–“ï¼‰
    for (let i = 0; i < 60; i++) {
      const result = await checkAvailability(/* ... */);
      
      if (result.currentStatus === 'â—‹') {
        // å³åº§ã«äºˆç´„å®Ÿè¡Œ
        await reserveImmediately(/* ... */);
        break;
      }
      
      // 1ç§’å¾…æ©Ÿ
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… çœŸã®ç§’å˜ä½ç›£è¦–ãŒå¯èƒ½
- âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦ä»¶ã€Œæ•°ç§’ã€œæ•°åç§’ã€ã‚’å®Œå…¨ã«æº€ãŸã™
- âœ… ç«¶åˆã«å‹ã¦ã‚‹å¯èƒ½æ€§å¤§å¹…å‘ä¸Š

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ è¿½åŠ ã‚³ã‚¹ãƒˆ: $5/æœˆ + å¾“é‡èª²é‡‘ï¼ˆæ¨å®š$2-5/æœˆï¼‰
- âŒ å®Ÿè£…è¤‡é›‘åº¦ãŒå¢—åŠ 
- âŒ 60ç§’Ã—ã‚µãƒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¶ˆè²»

**æ¨å®šã‚³ã‚¹ãƒˆ**:
```
Durable Objects: $5/æœˆï¼ˆåŸºæœ¬æ–™é‡‘ï¼‰
+ ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: $0.15/100ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
+ æŒç¶šæ™‚é–“: $12.50/GB-æœˆ

æœˆ10å›ã®é›†ä¸­ç›£è¦–æƒ³å®š:
10å› Ã— 60ç§’ Ã— 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’ = 600ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
â†’ ã»ã¼ç„¡æ–™

åˆè¨ˆ: $5-7/æœˆï¼ˆWorkers $5/æœˆ + DO $0-2/æœˆï¼‰
```

#### æ¡ˆ2: Workers Cronæœ€é©åŒ–ï¼ˆç¾å®Ÿçš„ï¼‰

**å®Ÿè£…æ–¹æ³•**:
```typescript
// é›†ä¸­ç›£è¦–æœŸé–“ä¸­ã¯é«˜é »åº¦ãƒã‚§ãƒƒã‚¯
if (target.intensiveMonitoringUntil && 
    now >= targetTime - 120000 && // ç›®æ¨™æ™‚åˆ»ã®2åˆ†å‰ã‹ã‚‰
    now <= targetTime + 120000) { // ç›®æ¨™æ™‚åˆ»ã®2åˆ†å¾Œã¾ã§
  
  // é€šå¸¸ã®1åˆ†Cronã ãŒã€ã“ã®æœŸé–“ã ã‘è¤‡æ•°å›ãƒã‚§ãƒƒã‚¯
  for (let i = 0; i < 3; i++) {
    const result = await checkAvailability(/* ... */);
    if (result.currentStatus === 'â—‹') {
      await reserveImmediately(/* ... */);
      break;
    }
    if (i < 2) await new Promise(resolve => setTimeout(resolve, 20000)); // 20ç§’å¾…æ©Ÿ
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… è¿½åŠ ã‚³ã‚¹ãƒˆä¸è¦
- âœ… å®Ÿè£…ãŒå˜ç´”
- âœ… 1åˆ†é–“ã«3å›ãƒã‚§ãƒƒã‚¯ï¼ˆ20ç§’é–“éš”ï¼‰

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ å®Œå…¨ãªç§’å˜ä½ç›£è¦–ã§ã¯ãªã„
- âŒ 20ç§’ã®ç©ºç™½æœŸé–“ãŒã‚ã‚‹
- âŒ CPUæ™‚é–“æ¶ˆè²»å¢—åŠ 

---

## âœ… ç¢ºèªæ¸ˆã¿: æ¤œç´¢æ–¹å¼ï¼ˆä¸¦åˆ—ç›£è¦–ï¼‰

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¦ä»¶

**è¦ä»¶**: ã€Œè¨­å®šã—ãŸå…¨æ–½è¨­ã®ä¸¦åˆ—ç›£è¦–ã«ã‚ˆã‚‹å–ã‚Šã“ã¼ã—ãªã—ã€  
**ç¾åœ¨ã®å®Ÿè£…**: âœ… **å®Ÿè£…æ¸ˆã¿**

### å®Ÿè£…ç¢ºèªï¼ˆworkers/src/index.ts: 1490-1640è¡Œï¼‰

```typescript
// ğŸš€ ä¸¦åˆ—å‡¦ç†ã§é«˜é€ŸåŒ–: ä»Šå›ã®3æ—¥åˆ†ã®ãƒã‚§ãƒƒã‚¯ã‚’åŒæ™‚å®Ÿè¡Œ
const checkPromises: Promise<{date: string; timeSlot: string; result: AvailabilityResult}>[] = [];

for (const date of datesToCheckThisRun) {
  for (const timeSlot of timeSlotsToCheck) {
    const promise = (async () => {
      let result: AvailabilityResult;
      
      if (target.site === 'shinagawa') {
        result = await checkShinagawaAvailability(/* ... */);
      } else {
        result = await checkMinatoAvailability(/* ... */);
      }
      
      return { date, timeSlot, result };
    })();
    
    checkPromises.push(promise);
  }
}

// ä¸¦åˆ—æ•°ã‚’åˆ¶é™ã—ã¦ãƒãƒƒãƒå‡¦ç†
const BATCH_SIZE = 5; // 5ä»¶ãšã¤å‡¦ç†
console.log(`[Check] ğŸš€ ä¸¦åˆ—å®Ÿè¡Œ: ${checkPromises.length}ä»¶ã®ç©ºãçŠ¶æ³ãƒã‚§ãƒƒã‚¯ï¼ˆãƒãƒƒãƒã‚µã‚¤ã‚º: ${BATCH_SIZE}ï¼‰`);

for (let i = 0; i < checkPromises.length; i += BATCH_SIZE) {
  const batch = checkPromises.slice(i, i + BATCH_SIZE);
  const batchResults = await Promise.all(batch);
  checkResults.push(...batchResults);
}
```

### è©•ä¾¡

**âœ… è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹**:
1. è¤‡æ•°æ—¥Ã—è¤‡æ•°æ™‚é–“å¸¯ã‚’ä¸¦åˆ—ãƒã‚§ãƒƒã‚¯
2. ãƒãƒƒãƒã‚µã‚¤ã‚º5ã§åˆ¶å¾¡ï¼ˆCPUæ™‚é–“å¯¾ç­–ï¼‰
3. å…¨çµæœã‚’åé›†å¾Œã«å‡¦ç†ï¼ˆå–ã‚Šã“ã¼ã—ãªã—ï¼‰

**å‹•ä½œãƒ•ãƒ­ãƒ¼**:
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼A: æ–½è¨­1,2,3 Ã— æ—¥ä»˜1,2,3 Ã— æ™‚é–“å¸¯A,B
â†’ 3æ–½è¨­ Ã— 3æ—¥ Ã— 2æ™‚é–“å¸¯ = 18ä»¶ã‚’ä¸¦åˆ—å®Ÿè¡Œ
â†’ ãƒãƒƒãƒã‚µã‚¤ã‚º5: 4ãƒãƒƒãƒã§å®Œäº†ï¼ˆç´„4ç§’ï¼‰
â†’ å…¨18ä»¶ã®çµæœã‚’å‡¦ç†
```

---

## ğŸ“Š å„ªå…ˆåº¦æ•´ç†

### ğŸ”´ æœ€å„ªå…ˆ: é›†ä¸­ç›£è¦–æ©Ÿèƒ½ã®å®Ÿè£…æ±ºå®š

**é¸æŠè‚¢**:
1. **Durable Objectså°å…¥** â†’ ç§’å˜ä½ç›£è¦–ã€ã‚³ã‚¹ãƒˆ+$2-5/æœˆ
2. **Workers Cronæœ€é©åŒ–** â†’ 20ç§’é–“éš”ã€è¿½åŠ ã‚³ã‚¹ãƒˆãªã—

**æ¨å¥¨**: ã¾ãš**æ¡ˆ2ï¼ˆCronæœ€é©åŒ–ï¼‰**ã‚’å®Ÿè£…ã—ã¦ãƒ†ã‚¹ãƒˆ
- ç†ç”±: ã‚³ã‚¹ãƒˆä¸è¦ã€å®Ÿè£…ãŒå˜ç´”
- åŠ¹æœä¸ååˆ†ãªã‚‰æ¡ˆ1ã‚’æ¤œè¨

### âœ… å®Œäº†: ãã®ä»–ã®è¦ä»¶

- âœ… ç›£è¦–é–“éš”: 1åˆ†é–“éš”ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ‰¿èªï¼‰
- âœ… ä¸¦åˆ—ç›£è¦–: å®Ÿè£…æ¸ˆã¿ï¼ˆãƒãƒƒãƒã‚µã‚¤ã‚º5ï¼‰
- âœ… å…¨æ–½è¨­ãƒã‚§ãƒƒã‚¯: Promise.all ã§ä¸¦åˆ—å®Ÿè¡Œ

---

## ğŸš€ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å³åº§ã«å®Ÿæ–½å¯èƒ½ï¼ˆä»Šæ—¥ä¸­ï¼‰

**é›†ä¸­ç›£è¦–æ©Ÿèƒ½ã®å¼·åŒ–ï¼ˆæ¡ˆ2: Cronæœ€é©åŒ–ï¼‰**

```typescript
// workers/src/index.ts ã«è¿½åŠ 
async function intensiveCheck(target: MonitoringTarget, env: Env) {
  const now = Date.now();
  const targetTime = target.intensiveMonitoringUntil! - 120000; // ç›®æ¨™æ™‚åˆ»-2åˆ†
  const checkUntil = target.intensiveMonitoringUntil! + 120000; // ç›®æ¨™æ™‚åˆ»+2åˆ†
  
  // é›†ä¸­ç›£è¦–æœŸé–“ä¸­ï¼ˆç›®æ¨™æ™‚åˆ»ã®å‰å¾Œ2åˆ†ï¼‰ã‹ãƒã‚§ãƒƒã‚¯
  if (now < targetTime || now > checkUntil) {
    return false; // é€šå¸¸ç›£è¦–ã«æˆ»ã‚‹
  }
  
  console.log(`[IntensiveCheck] é›†ä¸­ç›£è¦–ãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œä¸­: ${target.facilityName}`);
  
  // 1åˆ†é–“ã«3å›ãƒã‚§ãƒƒã‚¯ï¼ˆ20ç§’é–“éš”ï¼‰
  for (let i = 0; i < 3; i++) {
    const result = await checkAvailability(target, env);
    
    if (result.currentStatus === 'â—‹') {
      console.log(`[IntensiveCheck] ğŸ‰ã€Œå–ã€â†’ã€Œâ—‹ã€æ¤œçŸ¥ï¼å³åº§ã«äºˆç´„`);
      await attemptReservation(target, env);
      return true;
    }
    
    if (i < 2) {
      console.log(`[IntensiveCheck] 20ç§’å¾…æ©Ÿä¸­... (${i + 1}/3)`);
      await new Promise(resolve => setTimeout(resolve, 20000));
    }
  }
  
  return false;
}

// scheduled() å†…ã§ä½¿ç”¨
if (target.detectedStatus === 'å–' && target.intensiveMonitoringUntil) {
  const reserved = await intensiveCheck(target, env);
  if (reserved) continue; // äºˆç´„æˆåŠŸã€æ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸
}
```

### ä¸­æœŸå¯¾å¿œï¼ˆåŠ¹æœä¸ååˆ†ãªå ´åˆï¼‰

**Durable Objectså°å…¥**
- ç§’å˜ä½ã®çœŸã®é›†ä¸­ç›£è¦–
- è¿½åŠ ã‚³ã‚¹ãƒˆ: $2-5/æœˆ
- å®Ÿè£…æœŸé–“: 2-3æ—¥

---

## ğŸ’¡ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèªäº‹é …

1. **é›†ä¸­ç›£è¦–æ©Ÿèƒ½ã®å®Ÿè£…æ–¹é‡**
   - æ¡ˆ2ï¼ˆ20ç§’é–“éš”ã€è¿½åŠ ã‚³ã‚¹ãƒˆãªã—ï¼‰ã§é–‹å§‹ã—ã¦OKï¼Ÿ
   - åŠ¹æœä¸ååˆ†ãªã‚‰æ¡ˆ1ï¼ˆç§’å˜ä½ã€+$2-5/æœˆï¼‰ã‚’æ¤œè¨ï¼Ÿ

2. **ä¸¦åˆ—ç›£è¦–ã®å‹•ä½œ**
   - ç¾åœ¨ã®å®Ÿè£…ï¼ˆãƒãƒƒãƒã‚µã‚¤ã‚º5ï¼‰ã§å•é¡Œãªã—ï¼Ÿ
   - ã‚ˆã‚Šé«˜é€ŸåŒ–ãŒå¿…è¦ï¼Ÿ

---

**ä½œæˆè€…**: GitHub Copilot  
**æœ€çµ‚æ›´æ–°**: 2025å¹´11æœˆ29æ—¥  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç¢ºèªå¾…ã¡
