# KVä½¿ç”¨é‡æœ€é©åŒ– è¨­è¨ˆæ›¸

## ğŸ“‹ å…¬å¼åˆ¶é™ï¼ˆCloudflare KV - Free Planï¼‰

### å‡ºå…¸
https://developers.cloudflare.com/kv/platform/limits/

### åˆ¶é™å€¤
| é …ç›® | Free Plan | Paid Plan |
|------|-----------|-----------|
| **Reads per day** | **100,000** | Unlimited |
| **Writes per day (different keys)** | **1,000** | Unlimited |
| **Writes per second (same key)** | 1 | 1 |
| Operations per Worker invocation | 1,000 | 1,000 |
| Storage per account | 1 GB | Unlimited |

### é‡è¦ãªåˆ¶ç´„
- âœ… Reads: 10ä¸‡å›/æ—¥ â†’ ä½™è£•ã‚ã‚Š
- âŒ **Writes: 1,000å›/æ—¥** â†’ **æœ€é‡è¦åˆ¶ç´„**
- âš ï¸ åŒä¸€ã‚­ãƒ¼ã¸ã®write: 1å›/ç§’ã¾ã§

---

## ğŸ”´ ç¾çŠ¶ã®å•é¡Œåˆ†æ

### ç¾åœ¨ã®å®Ÿè£…ï¼ˆ3æ–½è¨­ç›£è¦–æ™‚ï¼‰

#### Cronå®Ÿè¡Œé »åº¦
- **1åˆ†ã”ã¨** = 1,440å›/æ—¥

#### 1å›ã®Cronå®Ÿè¡Œã§ã®KVæ“ä½œ
```
1. ç›£è¦–ãƒªã‚¹ãƒˆå–å¾—: 1 read
2. å„æ–½è¨­(3ä»¶)ã”ã¨ã«:
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—: 1 read Ã— 3 = 3 reads
   - ç©ºãçŠ¶æ³ãƒã‚§ãƒƒã‚¯
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°: 1 write Ã— 3 = 3 writes
   - äºˆç´„å±¥æ­´ç¢ºèª: 1 read Ã— 3 = 3 reads

åˆè¨ˆ: 7 reads + 3 writes per Cron
```

#### 1æ—¥ã®KVä½¿ç”¨é‡
- **Reads**: 1,440 Ã— 7 = **10,080 reads/æ—¥** âœ… (åˆ¶é™å†…)
- **Writes**: 1,440 Ã— 3 = **4,320 writes/æ—¥** âŒ (åˆ¶é™ã®4.3å€)

### æ‹¡å¼µæ™‚ï¼ˆ24æ–½è¨­ç›£è¦–ï¼‰ã®äºˆæ¸¬
- **Reads**: 1,440 Ã— (1 + 24Ã—2) = **70,560 reads/æ—¥** âœ… (åˆ¶é™å†…)
- **Writes**: 1,440 Ã— 24 = **34,560 writes/æ—¥** âŒ (åˆ¶é™ã®34.6å€)

---

## âœ… æœ€é©åŒ–è¨­è¨ˆ

### ç›®æ¨™
- 24æ–½è¨­ç›£è¦–ã§ **Free Planåˆ¶é™å†…** ã«åã‚ã‚‹
- Reads < 100,000/æ—¥
- **Writes < 1,000/æ—¥** â† æœ€é‡è¦

### æœ€é©åŒ–æˆ¦ç•¥

#### 1. Croné »åº¦ã®å‰Šæ¸›ï¼ˆé‡è¦åº¦: ğŸ”´ HIGHï¼‰
```
ç¾çŠ¶: */1 * * * * (1åˆ†ã”ã¨ = 1,440å›/æ—¥)
â†“
å¤‰æ›´: */5 * * * * (5åˆ†ã”ã¨ = 288å›/æ—¥)

åŠ¹æœ: KVæ“ä½œãŒ 1/5 ã«å‰Šæ¸›
```

#### 2. ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å°å…¥ï¼ˆé‡è¦åº¦: ğŸ”´ HIGHï¼‰
```typescript
// Workerså†…ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
const sessionCache = new Map<string, {
  sessionId: string;
  expires: number; // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
}>();

const monitoringListCache = {
  data: [] as any[],
  expires: 0
};

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™
const SESSION_CACHE_TTL = 5 * 60 * 1000; // 5åˆ†
const MONITORING_LIST_CACHE_TTL = 3 * 60 * 1000; // 3åˆ†
```

**å®Ÿè£…ç®‡æ‰€:**
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—: KV read â†’ ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆ
- ç›£è¦–ãƒªã‚¹ãƒˆå–å¾—: KV read â†’ ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆ

**åŠ¹æœ:**
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®KV read: 0å›ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆæ™‚ï¼‰
- ç›£è¦–ãƒªã‚¹ãƒˆã®KV read: 1å›/3åˆ† = 480å›/æ—¥ â†’ 96å›/æ—¥

#### 3. å¤‰æ›´æ¤œçŸ¥ã«ã‚ˆã‚‹é¸æŠçš„Writeï¼ˆé‡è¦åº¦: ğŸ”´ HIGHï¼‰
```typescript
// ç¾åœ¨ã®å®Ÿè£…ï¼ˆå•é¡Œï¼‰
await kv.put(`monitoring:${id}`, JSON.stringify(data)); // æ¯å›write

// æœ€é©åŒ–å¾Œ
const previousStatus = existingData.status;
const newStatus = checkResult.status;

if (previousStatus !== newStatus) {
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰åŒ–ãŒã‚ã‚‹å ´åˆã®ã¿write
  await kv.put(`monitoring:${id}`, JSON.stringify(data));
  console.log(`[Optimized] Status changed: ${previousStatus} â†’ ${newStatus}`);
} else {
  console.log(`[Optimized] No change, skipping write`);
}
```

**åŠ¹æœ:**
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰åŒ–ç‡ã‚’10%ã¨ä»®å®š
- Writeså‰Šæ¸›: 90%å‰Šæ¸›

#### 4. ãƒãƒƒãƒå‡¦ç†ã®æœ€é©åŒ–ï¼ˆé‡è¦åº¦: ğŸŸ¡ MEDIUMï¼‰
```typescript
// ç¾åœ¨: å€‹åˆ¥ã«KV read
for (const target of targets) {
  const session = await kv.get(`session:${target.userId}`);
}

// æœ€é©åŒ–: 1å›ã®KVæ“ä½œã§è¤‡æ•°å–å¾—ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
const allSessions = await kv.get('sessions:batch');
```

**åŠ¹æœ:**
- KV readå›æ•°å‰Šæ¸›: æœ€å¤§50%

---

## ğŸ“Š æœ€é©åŒ–å¾Œã®è¦‹ç©ã‚‚ã‚Š

### 24æ–½è¨­ç›£è¦–æ™‚ã®KVä½¿ç”¨é‡

#### Cronå®Ÿè¡Œé »åº¦
- **5åˆ†ã”ã¨** = 288å›/æ—¥

#### 1å›ã®Cronå®Ÿè¡Œã§ã®KVæ“ä½œï¼ˆæœ€é©åŒ–å¾Œï¼‰
```
1. ç›£è¦–ãƒªã‚¹ãƒˆå–å¾—:
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ(95%): 0 reads
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹(5%): 1 read
   â†’ å¹³å‡ 0.05 reads

2. å„æ–½è¨­(24ä»¶)ã”ã¨ã«:
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—:
     - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ(90%): 0 reads
     - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹(10%): 1 read Ã— 24 Ã— 0.1 = 2.4 reads
   
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:
     - å¤‰åŒ–ã‚ã‚Š(10%): 1 write Ã— 24 Ã— 0.1 = 2.4 writes
     - å¤‰åŒ–ãªã—(90%): 0 writes
   
   - äºˆç´„å±¥æ­´ç¢ºèª:
     - å¿…è¦æ™‚ã®ã¿(5%): 1 read Ã— 24 Ã— 0.05 = 1.2 reads

åˆè¨ˆ: 3.65 reads + 2.4 writes per Cron
```

#### 1æ—¥ã®KVä½¿ç”¨é‡ï¼ˆæœ€é©åŒ–å¾Œï¼‰
- **Reads**: 288 Ã— 3.65 = **1,051 reads/æ—¥** âœ… (åˆ¶é™ã®1%)
- **Writes**: 288 Ã— 2.4 = **691 writes/æ—¥** âœ… (åˆ¶é™ã®69%)

### å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³
- Reads: åˆ¶é™ã®1% â†’ **ä½™è£•99%**
- Writes: åˆ¶é™ã®69% â†’ **ä½™è£•31%**

---

## ğŸš€ å®Ÿè£…è¨ˆç”»

### Phase 1: ç·Šæ€¥å¯¾å¿œï¼ˆä»Šæ—¥ä¸­ï¼‰
1. âœ… Cronåœæ­¢ï¼ˆå®Œäº†ï¼‰
2. âœ… ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…ï¼ˆå®Œäº†ï¼‰
3. âœ… å¤‰æ›´æ¤œçŸ¥Writeå®Ÿè£…ï¼ˆå®Œäº†ï¼‰
4. âœ… Cron 5åˆ†é–“éš”åŒ–ï¼ˆå®Œäº†ï¼‰
5. âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼ˆVersion: 6c8ea614-6762-4e15-ad70-c7fc5431680cï¼‰

### Phase 2: æ¤œè¨¼ï¼ˆæ˜æ—¥ï¼‰
1. KVä½¿ç”¨é‡ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
2. å®Ÿéš›ã®writeå›æ•°è¨ˆæ¸¬
3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ç¢ºèª

### Phase 3: æœ€é©åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
1. ãƒãƒƒãƒå‡¦ç†å®Ÿè£…
2. Intensiveç›£è¦–ã®èª¿æ•´
3. ã•ã‚‰ãªã‚‹å‰Šæ¸›ãŒå¿…è¦ãªå ´åˆã®å¯¾ç­–

---

## ğŸ“ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
- [x] `sessionCache` Mapä½œæˆ
- [x] `monitoringListCache` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
- [x] `getCachedSession()` é–¢æ•°å®Ÿè£…
- [x] `getCachedMonitoringList()` é–¢æ•°å®Ÿè£…
- [x] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆ5min/3min TTLï¼‰
- [x] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹æ™‚ã®KVå–å¾—
- [x] ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯

### å¤‰æ›´æ¤œçŸ¥Write
- [x] æ—¢å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
- [x] æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã®æ¯”è¼ƒ
- [x] å¤‰æ›´æ™‚ã®ã¿writeå®Ÿè¡Œï¼ˆ`updateMonitoringTargetOptimized`ï¼‰
- [x] ãƒ­ã‚°å‡ºåŠ›ï¼ˆå¤‰æ›´ã‚ã‚Š/ãªã—ï¼‰

### Cronè¨­å®š
- [x] `wrangler.toml` ä¿®æ­£: `*/5 * * * *`
- [x] ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆVersion: 6c8ea614ï¼‰
- [x] å‹•ä½œç¢ºèªï¼ˆæ¬¡å›Cronå®Ÿè¡Œã‚’å¾…æ©Ÿä¸­ï¼‰

### ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‹•ä½œç¢ºèª
- [ ] writeå›æ•°ã‚«ã‚¦ãƒ³ãƒˆ
- [ ] 24æ™‚é–“é‹ç”¨ãƒ†ã‚¹ãƒˆ

---

## ğŸ” ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°æŒ‡æ¨™

### è¿½è·¡ã™ã¹ããƒ¡ãƒˆãƒªã‚¯ã‚¹
1. **KV Reads/day** - ç›®æ¨™: < 100,000
2. **KV Writes/day** - ç›®æ¨™: < 1,000
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡** - ç›®æ¨™: > 80%
4. **Writeå‰Šæ¸›ç‡** - ç›®æ¨™: > 90%

### ãƒ­ã‚°å‡ºåŠ›
```typescript
console.log('[KV Metrics]', {
  reads: kvReadsCount,
  writes: kvWritesCount,
  cacheHitRate: cacheHits / totalRequests,
  writeSkipped: writesSkipped / totalWrites
});
```

---

## ğŸ’° ã‚³ã‚¹ãƒˆæ¯”è¼ƒ

### Free Planï¼ˆæœ€é©åŒ–å¾Œï¼‰
- æœˆé¡: $0
- åˆ¶é™å†…ã§24æ–½è¨­ç›£è¦–å¯èƒ½ âœ…

### Paid Planï¼ˆ$5/æœˆï¼‰
- Reads: Unlimited
- Writes: Unlimited
- å¿…è¦æ€§: **ãªã—**ï¼ˆæœ€é©åŒ–ã§å¯¾å¿œå¯èƒ½ï¼‰

---

## ğŸ“… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

| æ—¥ä»˜ | ã‚¿ã‚¹ã‚¯ | çŠ¶æ…‹ |
|------|--------|------|
| 11/22 | å•é¡Œç™ºè¦šãƒ»Cronåœæ­¢ | âœ… å®Œäº† |
| 11/23 | è¨­è¨ˆæ›¸ä½œæˆ | ğŸ”„ é€²è¡Œä¸­ |
| 11/23 | Phase 1å®Ÿè£… | â³ å¾…æ©Ÿ |
| 11/24 | å‹•ä½œç¢ºèªãƒ»KVåˆ¶é™ãƒªã‚»ãƒƒãƒˆ | â³ å¾…æ©Ÿ |
| 11/24 | Phase 2æ¤œè¨¼ | â³ å¾…æ©Ÿ |
| 11/25~ | æœ¬ç•ªé‹ç”¨é–‹å§‹ | â³ å¾…æ©Ÿ |

---

## ğŸ¯ æˆåŠŸåŸºæº–

1. âœ… 24æ–½è¨­ã‚’ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§ç›£è¦–å¯èƒ½
2. âœ… KV Writes < 1,000/æ—¥
3. âœ… ç›£è¦–ç²¾åº¦ç¶­æŒï¼ˆ5åˆ†é–“éš”ã§ã‚‚ååˆ†ï¼‰
4. âœ… ã‚·ã‚¹ãƒ†ãƒ å®‰å®šç¨¼åƒï¼ˆ24æ™‚é–“é€£ç¶šï¼‰

---

**ä½œæˆæ—¥**: 2025/11/22  
**æœ€çµ‚æ›´æ–°**: 2025/11/22  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å®Ÿè£…å¾…æ©Ÿä¸­
