# Phase 1 å®Œäº†å ±å‘Š

## ğŸ“… å®Ÿæ–½æ—¥æ™‚
2025å¹´1æœˆ31æ—¥

## âœ… å®Œäº†é …ç›®

### 1. ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: 5åˆ†é–“ã®TTLã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒ
- **ç›£è¦–ãƒªã‚¹ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥**: 3åˆ†é–“ã®TTLã§ç›£è¦–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¸€è¦§ã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒ
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡**: ç›®æ¨™80%ä»¥ä¸Šï¼ˆå®Ÿæ¸¬ã¯æ˜æ—¥ã®Cronå®Ÿè¡Œå¾Œã«ç¢ºèªï¼‰

å®Ÿè£…é–¢æ•°:
```typescript
getCachedSession(userId, kv)       // ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆï¼‰
getCachedMonitoringList(kv)       // ç›£è¦–ãƒªã‚¹ãƒˆå–å¾—ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å„ªå…ˆï¼‰
```

### 2. å¤‰æ›´æ¤œçŸ¥Writeå®Ÿè£…
- **æœ€é©åŒ–ãƒ­ã‚¸ãƒƒã‚¯**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿KVã«write
- **Writeå‰Šæ¸›ç‡**: ç›®æ¨™90%ï¼ˆå®Ÿæ¸¬ã¯æ˜æ—¥ã®Cronå®Ÿè¡Œå¾Œã«ç¢ºèªï¼‰

å®Ÿè£…é–¢æ•°:
```typescript
updateMonitoringTargetOptimized(target, newStatus, kv)
```

å‹•ä½œ:
- å‰å›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ = æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â†’ **writeã‚¹ã‚­ãƒƒãƒ—** (kvMetrics.writesSkipped++)
- å‰å›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â‰  æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â†’ **writeã®ã¿** (kvMetrics.writes++)

### 3. Croné–“éš”å¤‰æ›´
- **Before**: `*/1 * * * *` (1åˆ†é–“éš”) â†’ 1,440å›/æ—¥
- **After**: `*/5 * * * *` (5åˆ†é–“éš”) â†’ 288å›/æ—¥
- **å‰Šæ¸›ç‡**: 80%å‰Šæ¸›

### 4. KVãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
æ–°è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ :
```
GET /api/metrics/kv
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:
```json
{
  "reads": 1051,
  "writes": 691,
  "cacheHits": 250,
  "cacheMisses": 38,
  "writesSkipped": 2300,
  "cacheHitRate": 0.868,
  "writeSkipRate": 0.908,
  "elapsedMinutes": 1440,
  "resetAt": 1643673600000
}
```

### 5. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- **Version ID**: `6c8ea614-6762-4e15-ad70-c7fc5431680c`
- **Cron Schedule**: `*/5 * * * *` (æœ‰åŠ¹åŒ–æ¸ˆã¿)
- **URL**: https://tennis-yoyaku-api.kanda02-1203.workers.dev
- **ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚**: 2025å¹´1æœˆ31æ—¥

---

## ğŸ“Š äºˆæ¸¬åŠ¹æœï¼ˆè¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚ˆã‚Šï¼‰

### KVä½¿ç”¨é‡ï¼ˆ3æ–½è¨­ã®å ´åˆï¼‰
| é …ç›® | æœ€é©åŒ–å‰ | æœ€é©åŒ–å¾Œ | å‰Šæ¸›ç‡ |
|------|----------|----------|--------|
| **1å›ã®Cron** | 7 reads + 3 writes | 3.65 reads + 2.4 writes | -48% reads, -20% writes |
| **1æ—¥ã®åˆè¨ˆ** | 10,080 reads + 4,320 writes | 1,051 reads + 691 writes | -90% reads, -84% writes |
| **åˆ¶é™ã¨ã®æ¯”è¼ƒ** | 100,000 reads âœ… / 1,000 writes âŒ | 100,000 reads âœ… / 1,000 writes âœ… | - |

### 24æ–½è¨­ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®äºˆæ¸¬
- **Reads**: 1,051 reads/æ—¥ï¼ˆåˆ¶é™ã®1%ï¼‰
- **Writes**: 691 writes/æ—¥ï¼ˆåˆ¶é™ã®69%ï¼‰
- **æ®‹ä½™ãƒãƒ¼ã‚¸ãƒ³**: 31%

---

## ğŸ” æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— (Phase 2)

### æ˜æ—¥ï¼ˆKVåˆ¶é™ãƒªã‚»ãƒƒãƒˆå¾Œï¼‰
1. **24æ™‚é–“ç›£è¦–**
   - KVãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å®šæœŸçš„ã«ç¢ºèª
   - å®Ÿéš›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã‚’æ¸¬å®š
   - å®Ÿéš›ã®writeå‰Šæ¸›ç‡ã‚’æ¸¬å®š

2. **ç›®æ¨™å€¤ã¨ã®æ¯”è¼ƒ**
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡: ç›®æ¨™ > 80%
   - Writeå‰Šæ¸›ç‡: ç›®æ¨™ > 90%
   - ç·Writeæ•°: ç›®æ¨™ < 1,000/æ—¥

3. **èª¿æ•´ãŒå¿…è¦ãªå ´åˆ**
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTLã®å»¶é•·ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
   - Croné–“éš”ã®èª¿æ•´ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

### 24æ–½è¨­ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ï¼ˆPhase 2å®Œäº†å¾Œï¼‰
1. å“å·åŒºã®å…¨4ã‚³ãƒ¼ãƒˆã‚’è¿½åŠ 
2. æ¸¯åŒºã®å…¨10-20ã‚³ãƒ¼ãƒˆã‚’è¿½åŠ 
3. 24æ™‚é–“ç›£è¦–ã—ã¦KVä½¿ç”¨é‡ã‚’ç¢ºèª
4. 1,000 writes/æ—¥ä»¥å†…ã«åã¾ã‚‹ã“ã¨ã‚’æ¤œè¨¼

---

## ğŸ¯ æˆåŠŸåŸºæº–

### Phase 1ï¼ˆä»Šå›å®Œäº†ï¼‰
- [x] ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…å®Œäº†
- [x] å¤‰æ›´æ¤œçŸ¥Writeå®Ÿè£…å®Œäº†
- [x] Cron 5åˆ†é–“éš”åŒ–å®Œäº†
- [x] ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ
- [x] ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 

### Phase 2ï¼ˆæ˜æ—¥æ¤œè¨¼ï¼‰
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ > 80%
- [ ] Writeå‰Šæ¸›ç‡ > 90%
- [ ] ç·Writeæ•° < 1,000/æ—¥

### Phase 3ï¼ˆæœ€çµ‚æ¤œè¨¼ï¼‰
- [ ] 24æ–½è¨­ã§Writeæ•° < 1,000/æ—¥
- [ ] ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§å•é¡Œãªãé‹ç”¨å¯èƒ½

---

## ğŸ“ æ³¨æ„äº‹é …

1. **Cronåˆå›å®Ÿè¡Œ**: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€æ¬¡ã®5åˆ†åŒºåˆ‡ã‚Šï¼ˆä¾‹: 12:00, 12:05, 12:10...ï¼‰ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
2. **ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒªã‚»ãƒƒãƒˆ**: Workerå†èµ·å‹•æ™‚ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯0ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™
3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¿å‘½**: WorkerãŒä¸€å®šæ™‚é–“ã‚¢ã‚¤ãƒ‰ãƒ«çŠ¶æ…‹ã ã¨ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
4. **KVåˆ¶é™ãƒªã‚»ãƒƒãƒˆ**: UTC 0:00ï¼ˆæ—¥æœ¬æ™‚é–“ 9:00ï¼‰ã«æ—¥æ¬¡åˆ¶é™ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [KV_OPTIMIZATION_DESIGN.md](./KV_OPTIMIZATION_DESIGN.md) - è©³ç´°ãªè¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [wrangler.toml](./workers/wrangler.toml) - Cronè¨­å®š
- [index.ts](./workers/src/index.ts) - å®Ÿè£…ã‚³ãƒ¼ãƒ‰
