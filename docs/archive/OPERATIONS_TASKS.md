# 運用タスク管理

システムの運用に関する改善タスク・既知の制限事項を記録します。

## 📋 現在の運用状態

**最終更新**: 2025年11月29日  
**システムバージョン**: v2.0  
**運用状態**: ✅ 正常稼働中

---

## 🔧 既知の制限事項と今後の改善タスク

### 1. 施設データの動的取得（優先度: 低）

**現状**:
- 品川区・港区の施設リストは**ハードコードされたフォールバックデータ**を使用
- ユーザーごとのアカウント権限に基づく正確なデータを返している
- データ内容:
  - 品川区: 13コート（4施設）
  - 港区: 10コート（3施設）

**制限事項**:
- HTMLパース処理は実装済みだが、サイトのナビゲーションフローが複雑で現在は失敗
- フォールバックデータは実際のアカウント権限と一致しており、実用上は問題なし

**将来的な改善が必要な場合**:
1. 新しい施設が追加される
2. 既存施設のコート数が変更される
3. アカウント権限が変更される

**改善方法**:
```typescript
// workers/src/scraper.ts
// getShinagawaFacilities() 関数
// getMinatoFacilities() 関数
// 
// 課題: 
// - 品川区サイトのナビゲーションフローを再調査
// - 正しいPOST/GETリクエストシーケンスの特定
// - Shift_JISエンコーディングの正しい処理
// - HTMLセレクタパターンの修正
```

**手動更新方法** (施設変更時):
```typescript
// workers/src/scraper.ts の以下の関数を更新:

// 品川区
function getShinagawaFacilitiesFallback(): Facility[] {
  // ここにハードコードされた施設データ
}

// 港区
function getMinatoFacilitiesFallback(): Facility[] {
  // ここにハードコードされた施設データ
}
```

**対応優先度**: 🟡 低（現在のデータが正確で実用上問題なし）

**備考**:
- 実装コード: `workers/src/scraper.ts` L440-850
- デバッグログは詳細に出力済み（HTMLパース失敗時の情報を収集可能）
- ログ確認: `npx wrangler tail` でリアルタイム監視可能

---

## ✅ 解決済みタスク

### セッションベース認証の実装
- **完了日**: 2025年11月28日
- **内容**: ID/パスワード方式からセッション方式への移行
- **結果**: reCAPTCHA対応に備えた柔軟な認証フロー

### ユーザー別施設キャッシュ
- **完了日**: 2025年11月29日
- **内容**: 施設リストをユーザーごとにキャッシュ（6時間TTL）
- **結果**: アカウント権限の違いに対応

### フォールバックデータの正確性確保
- **完了日**: 2025年11月29日
- **内容**: 実際のログインデータに基づきフォールバックを修正
- **結果**: 品川11→13コート、港30→10コートに調整し、実データと一致

---

## 📝 運用メモ

### 定期確認項目

#### 毎月
- [ ] 施設の追加/削除がないか公式サイトを確認
- [ ] 予約システムのUI変更がないか確認
- [ ] Cloudflare Workers の使用量チェック

#### 四半期ごと
- [ ] セキュリティパッチの適用
- [ ] 依存パッケージの更新
- [ ] ログの分析とパフォーマンス確認

#### 年次
- [ ] ドキュメントの全面見直し
- [ ] アーキテクチャの最適化検討
- [ ] ユーザーフィードバックの反映

---

## 🐛 トラブルシューティング

### 施設リストが表示されない場合

1. **Cloudflare Workers のログを確認**
   ```bash
   cd workers
   npx wrangler tail
   ```

2. **キャッシュをクリア**
   - Workers Dashboard → KV → `shinagawa:facilities:*` を削除
   - 6時間後に自動的に再取得される

3. **フォールバックデータの確認**
   - `[Facilities] Using fallback` ログが出ていれば正常
   - データ内容は `workers/src/scraper.ts` で確認

### HTMLパースエラーが頻発する場合

1. **予約サイトのHTML構造変更の可能性**
   - ブラウザで手動ログインして確認
   - DevToolsでHTML構造をチェック

2. **一時的な対応**
   - フォールバックデータが正確であれば問題なし
   - ログに `[Parser] Could not find mansion-select` が出るのは既知の状態

3. **恒久的な対応**
   - HTML構造の再調査が必要
   - このドキュメントの「施設データの動的取得」セクションを参照

---

## 📞 サポート

問題が発生した場合:
1. [GitHub Issues](https://github.com/youshi-kanda/tennis_yoyaku/issues) で報告
2. Cloudflare Workers のログを添付
3. 発生日時と状況を詳しく記載

---

**このドキュメントは運用中に発見された課題を継続的に更新します。**
