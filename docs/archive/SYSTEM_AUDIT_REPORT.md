# システム精査レポート - 有料プラン移行後の正確な仕様

**作成日**: 2025年11月29日  
**対象**: テニスコート自動予約システム  
**目的**: 有料プラン移行後の正確な仕様整理とクライアント要件との整合性確認

---

## 📊 精査サマリー

### 現状の事実
1. **Cloudflare Workers有料プラン契約済み** ($5/月)
2. **KV書き込み制限**: 実質的に無制限（有料プラン）
3. **サブリクエスト制限**: 1,000/実行（無料プランの20倍）
4. **CPU時間**: 30秒/実行（無料プランの3,000倍）
5. **AWS Lambda集中監視**: 未実装（ドキュメントにのみ記載）

### 修正が必要な項目

#### ✅ 完了: workers/src/index.ts
- サブリクエスト制限関連のコメント・定数修正
- 無料プラン前提のログメッセージ削除
- KVエラーメッセージの簡素化

#### 🔄 進行中: ドキュメント修正
- KV_OPTIMIZATION_PLAN.md: 古い無料プラン制約の記載
- SYSTEM_REQUIREMENTS_ANALYSIS.md: 無料プラン試算
- PROJECT_PLAN.md: AWS Lambda計画（未実装）
- SYSTEM_OVERVIEW.md: 無料プラン推奨記載

#### ⏸️ 保留: クライアント要件との整合性
- 監視間隔: 要件「数秒〜数十秒」vs 実装「5分間隔」（大幅乖離）
- 集中監視: 要件「10分刻み前後の秒単位」vs 実装「未実装」
- 検索方式: 要件「まとめて取得」vs 実装状況「要確認」

---

## 🎯 クライアント要件との整合性分析

### 要件定義書の主要要件

#### 1. 監視間隔
**要件**: 数秒〜数十秒単位で調整可能  
**現状**: 5分間隔（Cron: `*/5 * * * *`）  
**ギャップ**: 60〜300倍遅い  
**影響**: キャンセル枠の取りこぼしリスク大  
**推奨対応**: 
- 短期: 1分間隔に変更（Cron最短）
- 中期: Cloudflare Durable Objects検討（秒単位可能）

#### 2. 集中監視機能（取→○）
**要件**: 品川区の「取」→「○」変化を10分刻み前後の秒単位で監視  
**現状**: 未実装  
**ギャップ**: コア機能が欠落  
**影響**: 品川区の最も需要が高い機能が使えない  
**推奨対応**: 
- Workers有料プラン活用で十分実装可能
- 1分Cronで10分刻み前後2分間を高頻度チェック

#### 3. 検索方式
**要件**: A公園→B公園と順番ではなく、検索条件でまとめて取得  
**現状**: コード確認が必要  
**推奨対応**: scraper.ts の実装を確認し、最適化

#### 4. 5:00一斉処理
**要件**: 5:00:00に溜まった対象枠を一斉予約  
**現状**: Cron設定に `0 5 * * *` あり（実装確認必要）  
**推奨対応**: handle5AMBatchReservation関数の動作確認

#### 5. 深夜早朝時間帯対応
**要件**: 
- 24:00〜3:15: ログイン不可、既存セッション維持
- 3:15: セッションリセット
- 3:15〜5:00: 新規予約不可

**現状**: checkTimeRestrictions関数で実装済み  
**評価**: ✅ 要件満たす

---

## 💰 有料プラン前提の正確な制限値

### Cloudflare Workers Paid ($5/月) - 実際の契約プラン

```yaml
リクエスト制限: 10,000,000回/月
  - 1日あたり: 約333,333回
  - 1時間あたり: 約13,888回
  - 実質: 無制限に近い

サブリクエスト制限: 1,000回/実行
  - Cron 1回の実行で1,000回まで外部リクエスト可能
  - 無料プランの20倍

KV操作:
  - 読み取り: 無制限
  - 書き込み: 無制限（有料プランの大きなメリット）
  
CPU時間: 30秒/実行
  - スクレイピング処理に十分な時間
  - 無料プランの3,000倍

Cron実行: 最短1分間隔
  - Workers標準機能の制限
  - 秒単位実行には Durable Objects が必要
```

### 実際の運用可能範囲

**1分間隔Cronの場合**:
```
1日の実行回数: 1,440回
月間実行回数: 43,200回
月間リクエスト上限: 10,000,000回
→ Cron実行1回あたり: 約231リクエスト使用可能

実質的な制限:
- サブリクエスト: 1,000回/実行（先に到達）
- 複数施設・長期間の監視に十分な余裕
```

**監視可能規模の試算**:
```
1施設・1日の監視 = 約4サブリクエスト
  - セッション確認: 1
  - ログイン（必要時のみ）: 1
  - 空き状況取得: 2

1実行で監視可能:
- 1,000 ÷ 4 = 250施設・日の組み合わせ
- 例: 10施設 × 25日分 = 250
- 例: 5施設 × 50日分 = 250

結論: クライアント要件（複数施設・31日監視）を余裕で満たす
```

---

## 📝 修正すべきドキュメント一覧

### 1. KV_OPTIMIZATION_PLAN.md
**問題点**:
- 無料プランの1,000回/日制限を前提とした最適化計画
- KV書き込み削減の緊急性が強調されている

**修正内容**:
```markdown
# ✅ 有料プラン移行完了

Cloudflare Workers有料プラン ($5/月) 契約により、以下が解決:
- KV書き込み: 実質無制限
- サブリクエスト: 1,000/実行（無料の20倍）
- CPU時間: 30秒/実行（無料の3,000倍）

本ドキュメントの最適化計画は参考情報として保持。
現在は制限を気にせず実装可能。
```

### 2. SYSTEM_REQUIREMENTS_ANALYSIS.md
**問題点**:
- 無料プラン前提のサブリクエスト試算
- 「実行不可」の判定が多数

**修正内容**:
```markdown
# ✅ 更新: 有料プラン契約済み

以下の試算は無料プラン時代のものです。

現在の制限（Workers Paid $5/月）:
- サブリクエスト: 1,000/実行
- KV書き込み: 無制限
- CPU時間: 30秒/実行

→ すべてのケースが実行可能
```

### 3. PROJECT_PLAN.md
**問題点**:
- AWS Lambda集中監視の実装計画（Week 3）が記載
- 未実装機能を「実装予定」として記載

**修正内容**:
```markdown
# ⚠️ 注意: AWS Lambda集中監視は未実装

Week 3のLambda実装計画は保留中。
現状はCloudflare Workers（有料プラン）のみで運用。

代替案:
- Workers Cron 1分間隔で集中監視を実装可能
- Durable Objectsで秒単位監視も検討可能
```

### 4. SYSTEM_OVERVIEW.md
**問題点**:
- 「無料プラン推奨」「$5/月でアップグレード検討」の記載
- Durable Objects必須の誤解を招く表現

**修正内容**:
```markdown
# ✅ 現在のプラン

Cloudflare Workers Paid ($5/月) 契約済み
- KV書き込み: 無制限
- サブリクエスト: 1,000/実行
- CPU時間: 30秒/実行

クライアント要件を満たすために十分な制限値。
```

---

## 🚨 クリティカルな要件未達項目

### 1. 監視間隔の乖離（最優先対応）

**要件**: 数秒〜数十秒単位  
**現状**: 5分（300秒）  
**推奨**: 1分（60秒）に短縮

**実装方法**:
```toml
# wrangler.toml
[triggers]
crons = ["*/1 * * * *"]  # 5分 → 1分に変更
```

**懸念点**:
- 1分でも要件（数秒）には届かない
- Cronの仕様上、秒単位は Durable Objects が必要
- Durable Objects = 追加コスト発生

**クライアント確認事項**:
- 「数秒〜数十秒」は絶対条件か？
- 1分間隔で妥協可能か？
- 秒単位が必須なら Durable Objects 導入検討

### 2. 集中監視機能（取→○）の欠落

**要件**: 品川区の「取」が10分刻みで「○」に変わる瞬間を秒単位監視  
**現状**: 未実装  
**影響**: 品川区の最も需要が高い機能

**実装可能性**:
1. **Workers Cron（1分間隔）での実装**:
   ```typescript
   // 「取」検知時に次の10分刻み時刻を記録
   // 該当時刻の前後2分間（例: 10:08-10:12）は毎分チェック
   // 通常は5分間隔、集中時のみ1分間隔
   ```

2. **Durable Objectsでの実装（秒単位）**:
   ```typescript
   // 10分刻み時刻の前後60秒を秒単位でチェック
   // 追加コスト: $5/月 + 従量課金
   ```

**推奨**:
- まずはWorkers Cronで1分間隔実装
- 効果が不十分ならDurable Objects検討

### 3. 検索方式の確認

**要件**: 施設ごとではなく、検索条件でまとめて取得  
**確認必要**: workers/src/scraper.ts の実装

---

## 📋 推奨アクション

### 即座に実施（今日中）

1. **wrangler.toml修正**: Cron間隔を5分→1分に短縮
   ```toml
   [triggers]
   crons = ["*/1 * * * *", "0 5 * * *"]
   ```

2. **ドキュメント修正**: 無料プラン関連記載の更新
   - KV_OPTIMIZATION_PLAN.md
   - SYSTEM_REQUIREMENTS_ANALYSIS.md  
   - PROJECT_PLAN.md
   - SYSTEM_OVERVIEW.md

### 短期対応（1週間以内）

3. **集中監視機能実装**: Workers Cronベース（1分間隔）
   - 「取」検知ロジック追加
   - 10分刻み前後の高頻度チェック実装

4. **スクレイピング最適化確認**:
   - scraper.tsの実装確認
   - まとめて取得の実装状況確認

### 中期対応（クライアント要望次第）

5. **Durable Objects検討**: 秒単位監視が必須の場合
   - コスト試算
   - 実装PoC

6. **監視ターゲット上限実装**: システム安定性のため
   - ユーザーごと: 10-20ターゲット
   - システム全体: 100ターゲット

---

## 🎯 監視ターゲット上限の推奨値

### 有料プラン前提の計算

**1分間隔Cronの場合**:
```
サブリクエスト上限: 1,000/実行
1監視ターゲット = 約4リクエスト
→ 理論上の上限: 250ターゲット/実行

安全マージン50%:
→ 推奨上限: 125ターゲット/実行
```

**推奨設定**:
```typescript
const MONITORING_LIMITS = {
  perUser: 20,        // ユーザーごとの上限
  systemTotal: 100,   // システム全体の上限
  warning: 80         // 警告しきい値
};
```

**根拠**:
- 100ターゲット × 4リクエスト = 400リクエスト/実行
- 余裕率: 400/1,000 = 40%（安全）
- スケーラビリティ: 将来的な増加に対応可能

---

## 📌 結論

### 現状評価

**✅ 実装済み・正常動作**:
- PWA（3ステップウィザード、プッシュ通知）
- 通常監視（5分間隔）
- 自動予約機能
- セッション管理（24時間対応）
- 深夜早朝時間帯制御

**⚠️ 要件未達・要改善**:
- 監視間隔: 5分 vs 要件「数秒」（60〜300倍遅い）
- 集中監視: 未実装（品川区の重要機能）
- 監視ターゲット上限: 未設定

**❌ 不要・削除すべき**:
- AWS Lambda関連の記載（計画のみ、実装なし）
- 無料プラン前提のドキュメント記載

### 最優先アクション

1. **Cron間隔短縮**: 5分 → 1分（即日）
2. **ドキュメント更新**: 有料プラン前提に修正（即日）
3. **クライアント確認**:
   - 監視間隔「1分」で許容可能か？
   - 集中監視の実装優先度
   - 秒単位監視の必須性

---

**作成者**: GitHub Copilot  
**最終更新**: 2025年11月29日  
**ステータス**: レビュー待ち
