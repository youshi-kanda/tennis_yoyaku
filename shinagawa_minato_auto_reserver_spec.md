
# 品川区・港区 自動予約システム仕様書（完全版）

## 概要
本システムは、品川区および港区の施設予約サイトに対し、
「×→○」の通常空き監視と、「取→○」の集中監視（品川区のみ）を行い、
条件一致時に完全自動で予約処理を行うツールである。

Cloudflare Workers を基盤とし、Web UI にて設定・ログ管理・動作 ON/OFF が可能となる。

以下は GitHub/Copilot 開発のための正式仕様である。

---

## 対応エリア
- 品川区施設予約システム  
  https://www.cm9.eprs.jp/shinagawa/web/index.jsp
- 港区施設予約システム  
  https://web101.rsv.ws-scs.jp/minato/web/index.jsp（例示）

---

## 開発構成
### ■ バックエンド
- Cloudflare Workers
- 定期実行：Cron Trigger（1秒〜60秒間隔の柔軟監視）
- セッション維持：Cookie 管理（Workers KV）
- ログ保存：Workers KV or R2（選択可能）

### ■ Web 管理画面
- Cloudflare Pages + Workers（API連携）
- SPA構成（React or Vanilla）
- スマホ対応 UI

### ■ 主要機能
1. **完全自動予約**
2. **×→○ の通常監視**
3. **取→○ の10分刻み集中監視（品川専用）**
4. **秒単位監視（1秒〜任意）**
5. **予約成功/失敗ログ表示**
6. **ON/OFF切り替えスイッチ**
7. **施設・時間帯設定画面**

---

## 実装対象となる予約フロー（品川区）

### 1. ログイン
```
POST /shinagawa/web/rsvWUserAttestationLoginAction.do
userId
password
JSESSIONID（Cookie）
```

### 2. 検索条件ページへ遷移
```
POST /shinagawa/web/rsvWOpeInstSrchVacantAction.do
```

### 3. 空き判定（○ / × / 取）
HTML テーブルをパースして判定。

### 4. 予約確定フロー
- 規約画面
- 確認画面
- 人数入力
- 予約確定

5段階のページ遷移が必要。

---

## 港区との仕様差
| 項目 | 品川区 | 港区 |
|------|--------|-------|
| 「取」ステータス | あり | なし |
| 予約時の規約画面 | あり | **なし** |
| バッチ更新周期 | 10分単位（体感値あり） | 不明（一般的に即時 or 数分） |
| 集中監視 | 実装 | 不要 |

※ 港区は品川のロジックほぼ流用可能。

---

## セット割が可能な理由
- Workers の API 構造・クッキー管理・遷移型ログインの実装が共通
- HTML 構造も非常に近く、セレクタの調整程度で対応可
- 開発コストが 40〜50%削減されるため追加 25,000円で実現可能

---

## 監視ロジック

### 「×→○」通常監視
- 60秒〜任意間隔で実行
- 対象施設・時間帯を全探索
- ○ を検知した瞬間に予約フローへ突入

### 「取→○」集中監視（品川）
- 「取」を検知したスロットのみ監視対象へ追加
- 指定した「毎時10分±数秒」の範囲で **1秒監視**
- ○ を検知した瞬間予約へ突入
- バッチの 3〜4秒ズレも吸収できる

---

## 必要な情報（クライアント提供）
- 利用者番号（userId）
- パスワード
- 監視条件
  - 曜日
  - 時間帯
  - 対象施設
- 集中監視時間（例：毎時10分）
- 港区を同時に運用するか

---

## セキュリティ
- 平文保存は絶対にしない（Workers Secrets に保存）
- 予約サイトへの通信は HTTPS のみ
- Cookie は暗号化し KV に保管
- パスワード変更時は即時再設定可能

---

## 納品形式
### option A：完全お任せ運用（推奨）
- ユーザーは Web UI にログインするだけ
- サーバー管理・デプロイはすべてこちらが担当

### option B：引き渡し
- GitHub リポジトリを丸ごと渡す
- Cloudflare API トークンはクライアント側で作成して接続

後者は運用負荷がクライアント側に発生するため、
基本は Option A が一般的。

---

## 料金（事実のみ）
- 品川区プランD：90,000円
- 港区追加：25,000円（セット割）
- 合計：115,000円

---

## 今後の進め方
1. 専用ページの用意 → URL 提示
2. クライアントが内容確認後「正式依頼」
3. 情報共有（ID/パスワード・条件など）
4. 開発
5. テスト版提示
6. 本番運用開始

---

