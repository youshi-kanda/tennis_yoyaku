# 品川区・監視機能等 提供前検証レポート

## 1. 概要
クライアントへ先行して提供する「品川区の監視・検知・通知機能」について、現在の実装コードに基づき整合性と堅牢性の調査を行いました。

**結論**:
現在の実装は、自動予約機能が無効化（コメントアウト）されており、**「監視・検知・通知」のみが動作する仕様**となっています。クライアントへの提供要件を満たしています。

## 2. 機能の実装状況確認

### 2.1 監視機能 (Monitoring)
- **実装箇所**: `workers/src/do/UserAgent.ts`
- **動作**: 
  - Cloudflare Durable ObjectsのAlarm機能を使用し、**1分間隔**で定期的に実行されます。
  - 「アクティブ」なターゲットに対して並列（同時実行数制限あり）で空き状況チェックを行います。
  - 「取（キャンセル待ち）」ステータスを検知した場合、**15秒間の「集中監視（Hot Monitoring）」**（約1秒間隔）に自動的に切り替わります。

### 2.2 検知機能 (Detection)
- **実装箇所**: `workers/src/scraper/shinagawa.ts` (`checkShinagawaWeeklyAvailability`)
- **仕様**:
  - 対象サイトの「週間空き状況」ページをスクレイピングします。
  - HTML内の `<td id="YYYYMMDD_HH">` タグを解析し、以下の判定を行います。
    - `alt="空き"` または `calendar_available` → **「○」（空き）**
    - `alt="取消処理中"` または `calendar_delete` → **「取」（キャンセル待ち）**
  - **堅牢性**: ページ内のフォームパラメータ（`loginJKey` 等）を動的に抽出して次回のクエストに使用するため、セッション維持が堅牢に設計されています。

### 2.3 通知機能 (Notification)
- **実装箇所**: `workers/src/pushNotification.ts`, `UserAgent.ts`
- **仕様**: Web Push通知 (VAPID)
- **トリガー**:
  - **「○」「△」検知時**: `🎾 空き枠検知 (監視あり)` というタイトルで通知。本文に「※手動で予約してください」と明記されています。
  - **「取」検知時**: `🔥 キャンセル待ち検知` というタイトルで通知し、集中監視へ移行します。
  - **集中監視中に「○」になった場合**: `🔥 空き枠確保チャンス` と通知します。

### 2.4 自動予約機能の抑制
- **現状**: `UserAgent.ts` 内の `target.autoReserve` に基づく予約実行ロジックは **コメントアウト** されています。
- **整合性**: 「監視機能だけを先に渡したい」という要望に対し、コードレベルで予約機能が作動しないよう担保されています。

## 3. 堅牢性とリスク評価

### 3.1 アカウントロック回避の安全性評価 (重要)
**結論: アカウントロックのリスクは極めて低く設計されています。**

1.  **「失敗時即時停止」ポリシー (UserAgent.ts)**
    -   ログイン処理 (`doLogin`) で、パスワード間違いや予期せぬエラーが **1回でも** 発生すると、システムは **無期限停止 (Halt Forever)** 状態に移行します。
    -   「何度もリトライしてロックされる」という事態を物理的に防ぐ最強の安全策がとられています。
    -   再開するにはユーザーが管理画面から手動で設定保存（解除アクション）を行う必要があります。

2.  **ゾンビ状態による保護 (Wide Check)**
    -   通常監視中 (`checkWide`) にセッション切れが発生しても、現状のロジックでは**自動再ログインを行いません**。
    -   これにより、セッション切れ判定 → 自動再ログイン連打 → 誤検知によるロック、というループ発生のリスクが排除されています。（※副作用として、セッション切れ時に監視が止まったままになる仕様ですが、安全性重視の観点ではプラスです）

3.  **直列実行制御**
    -   `alarm()` メソッドはロック (`isProcessing`) で保護されており、Durable Objectの仕様と相まって、同時に複数のログイン処理が走ることはありません。これにより「多重ログインによるロック」を防いでいます。

### 3.2 その他の評価
- **セッション切れ対策**: `SHINAGAWA_SESSION_EXPIRED` エラーを検知した場合、自動的に再ログイン・セッション再取得を行うロジックが含まれていますが、前述の通り通常監視では抑制されています。
- **並列処理**: 複数の施設を監視する際、3並列で実行することでパフォーマンスとサーバー負荷のバランスが取られています。
- **HTML構造変更リスク**: 相手方サイトのHTML構造（特にIDの命名規則や画像のalt属性）が変更されると検知できなくなるリスクは常在しますが、現時点では一般的な構造変更には耐えうる正規表現で記述されています。

## 4. 推奨アクション
現在のコードベースのままデプロイすることで、「監視・検知・通知」機能のみを提供可能です。
特別な修正作業は不要です。
