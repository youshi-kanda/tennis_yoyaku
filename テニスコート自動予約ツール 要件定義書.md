テニスコート自動予約ツール 要件定義書（ドラフト）
1. 背景・目的
1.1 背景

クライアントは、港区・品川区の公共テニスコート予約において、
キャンセル発生時や「取 → ○」へのステータス変更時に、人の操作では間に合わず枠を取り逃している。

特に品川区では「取（取消処理中）」ステータスが10分刻みのバッチ処理で「○」に変わるため、秒単位の争奪戦になっている。

1.2 目的

品川区・港区のテニスコート予約システムを自動監視し、

「× → ○」（キャンセル等で空き発生）

「取 → ○」（バッチ更新による空き発生・品川区のみ）
を検知した際に、予約確定まで自動で実行することで、
手動予約では取りにくい枠を高確率で確保すること。

2. 対象範囲
2.1 対象自治体・サイト

品川区施設予約システム

URL（ログイン前）：https://www.cm9.eprs.jp/shinagawa/web/index.jsp

ベース：富士通 EPRS 系システム

特記事項：「○ / × / 取」 3種類のステータスあり

港区施設予約システム

URL（ログイン前）：https://web101.rsv.ws-scs.jp/web/index.jsp

ベース：品川区と同一基盤

特記事項：ステータスは「○ / ×」（「取」はなし）、規約同意画面なし

2.2 対象施設

両自治体の テニスコート を対象

将来的に体育館・野球場などへの拡張余地はあるが、本要件では範囲外

3. 利用イメージ・シナリオ

クライアントは Web 管理画面（PC / スマホ）上で、以下を設定する：

対象自治体（品川 / 港区）

対象施設（テニスコート）

曜日・時間帯条件

例：

土日祝：全日

平日：19:00〜21:00

「全施設」または一部施設のみ

「×→○」「取→○」を対象とするか

同日複数枠・同時間帯複数コートの取得方針

システムは設定内容に基づいて予約サイトを定期チェックし、条件に合う空きが見つかった場合に自動で予約フローを実行する。

予約成功・失敗・集中監視の結果はログおよび通知で確認できる。

4. 機能要件
4.1 監視条件の設定（Web管理画面）

対象自治体選択

品川区 / 港区（複数選択可）

施設選択

各自治体のテニスコート一覧から複数選択

全施設選択機能あり（「すべてのテニスコート」）

日時条件

曜日・祝日条件

平日 / 土日 / 土日祝 / 全曜日

任意の曜日組み合わせ（例：土・日・祝のみ）

時間帯条件

複数時間帯の指定

例：19:00–21:00、9:00–11:00 など

「土日祝は終日＋平日19–21時」といった複合条件も設定可能とする

監視対象ステータス

「× → ○」の監視（キャンセル等による空き）

「取 → ○」の監視（品川区のみ・後述の集中監視機能と連動）

複数枠・複数コートの取得方針（クライアント指定済）

同一日に複数枠が空いた場合：
→ その日の空きはすべて自動取得（A案）

同一日時・複数コートが同時に○になった場合：
→ すべて予約して OK（A案）

ただし後述の「重複防止」ロジックで、自身の既存予約・直前キャンセル枠の再取得は防ぐ。

“取→○”集中監視時の複数枠方針

モードA：複数枠すべて取得

モードB：優先順位順に1枠のみ取得

どちらかを設定画面から選択可能とする（クライアント希望「選択できるとベスト」）。

監視ON/OFF

システム全体のON/OFF

個別ターゲットごとのON/OFF（将来拡張でも可）

4.2 通常監視機能（「× → ○」）

目的

キャンセル等で「× → ○」に変化した枠を検知し、即予約する。

動作

条件に合致する範囲（自治体・施設・曜日・時間帯）で「空き状況検索」を一括実行し、結果一覧を取得。

A公園→B公園→C公園…と順番に回すのではなく、
検索条件でまとめて結果を取得する方式とする（クライアントへの回答内容）。

監視間隔

要件：数秒〜数十秒単位で調整可能な定期チェック

初期想定：数秒〜数秒台の間隔（例：3〜5秒）

実際の値・調整方法は技術・負荷・安定性を踏まえて設計（管理画面側で“標準 / 高速”モード切替も検討）。

予約フローとの連携

条件に一致する「○」を検知したら、即座に予約フロー（ログイン済みセッションでの処理）へ遷移する。

4.3 集中監視機能（「取 → ○」／品川区専用）

目的

「取」ステータスが、10分刻みのバッチ処理で「○」に変わる瞬間を狙って予約を入れる。

クライアントからの前提情報

「取」は1〜2時間以内に、必ず10分刻み（10:10, 10:20…）で○に変わる

○になる瞬間は「10分ちょうど」ではなく、数秒（3〜4秒程度）ずれる

24時以降に「取→○」が発生することも多い

3:15 にシステムリセットがあり、全セッションが切れる

5:00 で一斉に○枠が取得可能になる

動作要件

通常監視で「取」を検知した場合、その枠（日付・時間帯・施設）を記録する。

次の「10分刻み」の時刻を計算（例：10:10, 10:20 …）。

その前後の短時間（例：±数十秒間）だけ秒単位の集中監視を行い、
「取 → ○」に変化した瞬間に即予約フローへ入る。

集中監視の時間帯以外は通常監視のみに戻す（リソース節約）。

柔軟なパラメータ

集中監視を行う時間範囲（例：X分Y秒〜X分Z秒）

集中監視中のチェック間隔（例：1〜10秒）

連続で予約トライする回数
→ これらは設定値として外出し可能とする（管理画面または内部設定）。

複数枠同時発生時の動作

モードA：同時に空いた枠をすべて取りに行く

モードB：優先順位順に1枠のみ取りに行く

クライアント要望通り、A / B を切り替え可能とする。

4.4 自動予約フロー

品川区

ログイン

検索条件入力 → 検索実行

検索結果から対象枠（○）を選択

規約同意画面：チェック → 確認

予約内容確認画面：人数入力 → 予約ボタン

最終確認ポップアップ：OKクリック → 完了
→ 上記一連を完全自動化する。

港区

ログイン

検索条件入力 → 検索実行

検索結果から対象枠（○）を選択

規約同意画面なし（クライアント説明より）

予約内容確認 → 確定
→ 品川区とほぼ同等だが、規約画面の有無で分岐。

重複予約防止

当日の予約一覧を自動取得し、既に取得済みの枠はスキップ。

「自分でキャンセルした枠を再取得してしまう」ことを防ぐため、

当日予約情報

直前に自動予約・自動キャンセルした履歴
を基に再取得防止フラグを持つ。

4.5 ログイン・セッション管理

ログイン方式

利用者番号 + パスワード（画像認証なしであることを前提）

ログインは、自動監視・自動予約のためにシステムが行う。

セッション維持

可能な限り「ログイン状態を維持しながら監視」を行う。

24:00〜3:15 のログイン不可時間帯は、既存セッションが有効な範囲でのみ予約を行う。

3:15 にシステムリセットでセッションが全破棄されるため、

3:15〜5:00 は「ログインを伴う新規予約」はできない前提。

5:00:00 時点でログインを行い、
それまでに溜まっていた対象枠（×→○）について、可能な限り一斉に予約処理を行う。

理想動作（クライアント要望）

通常時：ログイン状態を維持しながら「×→○」監視 ＋ 予約フロー

必要に応じて：ログインから予約まで連続実行するパターンも許容

どちらか一方のみ対応する場合は「前者（ログイン維持）」を優先。

4.6 Web管理画面（プランD相当）

機能

条件設定（前述の監視条件）

監視ON/OFF切替

ログ表示（予約成功／失敗／エラー内容）

ステータス一覧（現在監視中のターゲット・状態）

将来的に「取 → ○」のステータス推移可視化も検討可

利用環境

PC / スマホブラウザから利用可能

スマホでの操作性（ボタンサイズ・レスポンシブ対応）を考慮する。

4.7 通知・ログ

通知（手段は任意：Web上の表示が必須。メール/プッシュは拡張扱い）

予約成功

予約失敗（理由を含む）

集中監視結果（成功/失敗）

ログ

日時・自治体・施設・コート名・時間帯・結果

エラー内容（ログイン失敗、サイト側エラー等）

5. 非機能要件（概要）

パフォーマンス

通常監視：数秒〜数十秒間隔で安定して動作

集中監視：「取→○」対象枠について、10分刻み前後は秒単位でチェック可能なこと。

可用性

予約サイトの仕様（メンテナンス、24:00〜3:15 ログイン不可等）に制約される前提。

セキュリティ

利用者番号・パスワードは暗号化して保存（平文保存しない）。

ログイン情報・予約情報は第三者に共有しない。

納品後、クライアントが任意にパスワード変更できる前提。

拡張性

他自治体への横展開（画面構造が類似の EPRS 系システム）を想定した設計。

6. 制約・前提条件

対象サイトにCAPTCHA（画像認証）が導入されていないこと。
→ 導入された場合、完全自動化は原則不可となるため仕様見直しが必要。

自動化は予約サイト側の利用規約を遵守する前提。

サイトの HTML 構造やパラメータが大きく変更された場合、
→ システム改修が必要となる。

7. 今後、要件定義で詰めるべき点

実運用における監視間隔の具体値（通常 / 集中監視）

5:00 一斉処理時の優先順位ルール（同一日時複数施設が大量に○になるケース）

通知手段（Webのみ / メール / プッシュ通知など）をどこまで初期リリースに含めるか